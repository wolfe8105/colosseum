<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#0a1128">
<title>The Colosseum — Enter the Arena</title>

<!-- Supabase CDN -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="colosseum-config.js"></script>
<script src="colosseum-auth.js"></script>

<style>
  @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@600;700;900&family=Barlow+Condensed:wght@400;600;700&display=swap');

  :root {
    --navy: #0a1128;
    --navy-light: #132240;
    --navy-mid: #1a2d4a;
    --red: #c1272d;
    --red-hover: #e63946;
    --gold: #d4a843;
    --gold-glow: #e8c460;
    --gold-dim: #b8922e;
    --white: #f0ece2;
    --white-dim: #a0a8b8;
    --error: #e74c3c;
    --success: #2ecc71;
    --font-display: 'Cinzel', serif;
    --font-body: 'Barlow Condensed', sans-serif;
    --glass-bg: rgba(255, 255, 255, 0.08);
    --glass-border: rgba(255, 255, 255, 0.15);
    --glass-heavy: rgba(255, 255, 255, 0.12);
    --safe-top: env(safe-area-inset-top, 0px);
    --safe-bottom: env(safe-area-inset-bottom, 0px);
  }

  *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: var(--font-body);
    background: linear-gradient(145deg, #1a2d4a 0%, #2d5a8e 25%, #5b8abf 50%, #7aa3d4 75%, #3d5a80 100%);
    color: var(--white);
    min-height: 100dvh;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: calc(20px + var(--safe-top)) 16px calc(20px + var(--safe-bottom));
    overflow-y: auto;
    -webkit-font-smoothing: antialiased;
    -webkit-tap-highlight-color: transparent;
  }

  /* Soft light wash overlay */
  body::before {
    content: '';
    position: fixed; inset: 0; z-index: -1;
    background:
      radial-gradient(ellipse at 25% 20%, rgba(255,255,255,0.08) 0%, transparent 50%),
      radial-gradient(ellipse at 75% 80%, rgba(212,168,67,0.06) 0%, transparent 45%);
  }

  /* Placeholder banner */
  .placeholder-banner {
    position: fixed; top: 0; left: 0; right: 0;
    background: linear-gradient(135deg, var(--gold-dim), var(--gold));
    color: var(--navy); text-align: center;
    padding: 8px 16px; font-size: 12px; font-weight: 700; z-index: 9999; letter-spacing: 0.5px;
  }

  /* Logo */
  .login-logo {
    font-family: var(--font-display);
    font-weight: 900;
    font-size: clamp(32px, 9vw, 48px);
    letter-spacing: 5px;
    text-align: center;
    margin-bottom: 4px;
    line-height: 1;
    color: var(--gold);
    text-shadow: 0 0 40px rgba(212,168,67,0.25);
  }

  .login-tagline {
    font-family: var(--font-body);
    font-size: 14px; font-weight: 600;
    color: var(--white-dim);
    text-align: center;
    margin-bottom: 32px;
    letter-spacing: 2px;
    text-transform: uppercase;
  }

  /* Card — glassmorphism with high edge contrast */
  .login-card {
    width: 100%; max-width: 400px;
    background: rgba(10, 17, 40, 0.85);
    backdrop-filter: blur(24px); -webkit-backdrop-filter: blur(24px);
    border: 1.5px solid rgba(255, 255, 255, 0.3);
    border-radius: 20px;
    padding: 24px 20px;
    box-shadow: 0 0 0 1px rgba(0,0,0,0.4), 0 12px 48px rgba(0,0,0,0.5);
  }

  /* Tabs */
  .login-tabs {
    display: flex; gap: 0;
    margin-bottom: 20px;
    border-bottom: 1px solid var(--glass-border);
  }
  .login-tab {
    flex: 1; background: none; border: none;
    color: var(--white-dim);
    font-family: var(--font-display); font-weight: 700;
    font-size: 16px; letter-spacing: 3px;
    padding: 10px 0; cursor: pointer; position: relative;
  }
  .login-tab.active { color: var(--gold); }
  .login-tab.active::after {
    content: ''; position: absolute;
    bottom: -1px; left: 0; right: 0;
    height: 2px; background: var(--gold);
  }

  /* Forms */
  .login-form { display: none; }
  .login-form.active { display: block; }
  .form-group { margin-bottom: 14px; }

  .form-label {
    display: block; font-size: 11px; font-weight: 700;
    color: var(--white-dim); text-transform: uppercase;
    letter-spacing: 1.5px; margin-bottom: 6px;
  }

  .form-input {
    width: 100%; min-height: 44px; padding: 10px 14px;
    background: rgba(10,17,40,0.6);
    border: 1px solid var(--glass-border);
    border-radius: 12px; color: var(--white);
    font-family: var(--font-body); font-size: 16px;
    outline: none; transition: border-color 0.2s;
  }
  .form-input:focus { border-color: var(--gold-dim); }
  .form-input::placeholder { color: rgba(160,168,184,0.4); }
  .form-input.error { border-color: var(--error); }

  .dob-row { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; }

  .form-select {
    width: 100%; min-height: 44px; padding: 10px 8px;
    background: rgba(10,17,40,0.6);
    border: 1px solid var(--glass-border);
    border-radius: 12px; color: var(--white);
    font-family: var(--font-body); font-size: 15px;
    outline: none; -webkit-appearance: none; cursor: pointer;
  }
  .form-select:focus { border-color: var(--gold-dim); }

  .checkbox-row {
    display: flex; align-items: flex-start; gap: 10px; margin: 16px 0;
  }
  .checkbox-row input[type="checkbox"] {
    width: 20px; height: 20px; margin-top: 2px;
    accent-color: var(--gold); flex-shrink: 0;
  }
  .checkbox-row label { font-size: 13px; color: var(--white-dim); line-height: 1.4; }
  .checkbox-row a { color: var(--gold); text-decoration: none; }

  /* Primary button */
  .btn-primary {
    width: 100%; min-height: 48px; padding: 12px;
    background: linear-gradient(135deg, var(--red) 0%, var(--red-hover) 100%);
    color: #fff; border: none; border-radius: 14px;
    font-family: var(--font-display); font-weight: 700;
    font-size: 16px; letter-spacing: 3px;
    cursor: pointer; transition: transform 0.15s, box-shadow 0.2s;
    box-shadow: 0 4px 16px rgba(193,39,45,0.3);
  }
  .btn-primary:active { transform: scale(0.98); }
  .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; }

  /* Divider */
  .divider {
    display: flex; align-items: center; gap: 12px;
    margin: 18px 0; color: var(--white-dim);
    font-size: 11px; text-transform: uppercase; letter-spacing: 1.5px;
  }
  .divider::before, .divider::after { content: ''; flex: 1; height: 1px; background: var(--glass-border); }

  /* OAuth buttons — DOMINANT */
  .oauth-btn {
    width: 100%; min-height: 52px; padding: 14px;
    display: flex; align-items: center; justify-content: center; gap: 12px;
    border-radius: 14px; color: var(--white);
    font-family: var(--font-display); font-weight: 700;
    font-size: 14px; letter-spacing: 2px;
    cursor: pointer; margin-bottom: 10px;
    transition: transform 0.15s, box-shadow 0.2s;
    border: none;
  }
  .oauth-btn:active { transform: scale(0.98); }
  .oauth-btn svg { width: 22px; height: 22px; flex-shrink: 0; }

  .oauth-google {
    background: #fff; color: #333;
    box-shadow: 0 4px 16px rgba(0,0,0,0.2);
  }
  .oauth-apple {
    background: #000; color: #fff;
    box-shadow: 0 4px 16px rgba(0,0,0,0.3);
  }

  /* Email expand toggle */
  .email-toggle {
    width: 100%; background: none; border: none;
    color: var(--white-dim); font-family: var(--font-body);
    font-size: 13px; font-weight: 600; letter-spacing: 1px;
    text-transform: uppercase; cursor: pointer;
    padding: 8px 0; text-align: center;
    transition: color 0.2s;
  }
  .email-toggle:active { color: var(--white); }

  .email-section {
    max-height: 0; overflow: hidden;
    transition: max-height 0.4s ease;
  }
  .email-section.open {
    max-height: 600px;
  }

  /* Messages */
  .form-msg {
    padding: 10px 14px; border-radius: 10px; font-size: 14px;
    margin-bottom: 14px; display: none;
  }
  .form-msg.error { display: block; background: rgba(231,76,60,0.12); color: var(--error); border: 1px solid rgba(231,76,60,0.25); }
  .form-msg.success { display: block; background: rgba(46,204,113,0.12); color: var(--success); border: 1px solid rgba(46,204,113,0.25); }

  /* Forgot link */
  .forgot-link {
    display: block; text-align: right;
    font-size: 13px; color: var(--gold);
    text-decoration: none; margin-top: -6px; margin-bottom: 14px;
  }

  /* Footer */
  .login-footer {
    text-align: center; margin-top: 24px;
    font-size: 12px; color: var(--white-dim);
  }
  .login-footer a { color: var(--gold); text-decoration: none; }

  /* Modals */
  .modal-overlay {
    position: fixed; inset: 0;
    background: rgba(0,0,0,0.7);
    backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
    display: none; align-items: center; justify-content: center;
    padding: 16px; z-index: 9999;
  }
  .modal-overlay.open { display: flex; }

  .modal-card {
    background: rgba(10, 17, 40, 0.9);
    backdrop-filter: blur(24px); -webkit-backdrop-filter: blur(24px);
    border: 1.5px solid rgba(255, 255, 255, 0.3);
    border-radius: 20px; padding: 24px 20px;
    width: 100%; max-width: 380px;
    box-shadow: 0 0 0 1px rgba(0,0,0,0.4), 0 12px 48px rgba(0,0,0,0.5);
  }
  .modal-card h3 {
    font-family: var(--font-display); font-weight: 900;
    font-size: 20px; letter-spacing: 2px; color: var(--gold);
    margin-bottom: 8px;
  }
  .modal-card p { font-size: 14px; color: var(--white-dim); margin-bottom: 16px; }
  .modal-close {
    margin-top: 10px; background: none;
    border: 1px solid var(--glass-border);
    color: var(--white-dim); padding: 10px;
    border-radius: 12px; width: 100%; font-size: 14px;
    font-family: var(--font-body); cursor: pointer;
  }
  .modal-close:active { background: rgba(255,255,255,0.05); }

  /* Sword decorative */
  .decor-sword {
    font-size: 40px; text-align: center; margin-bottom: 8px;
    opacity: 0.3; filter: drop-shadow(0 0 12px rgba(212,168,67,0.3));
  }
</style>
</head>
<body>

<!-- Placeholder banner -->
<div class="placeholder-banner" id="placeholder-banner" style="display:none;">
  ⚡ DEMO MODE — No Supabase connected. See colosseum-config.js
</div>

<!-- Decorative -->
<div class="decor-sword">⚔</div>

<!-- Logo -->
<div class="login-logo">COLOSSEUM</div>
<div class="login-tagline">Where opinions fight.</div>

<!-- Login Card -->
<div class="login-card">

  <!-- Tabs -->
  <div class="login-tabs">
    <button class="login-tab active" data-tab="login">LOG IN</button>
    <button class="login-tab" data-tab="signup">SIGN UP</button>
  </div>

  <!-- LOGIN FORM -->
  <form class="login-form active" id="form-login" autocomplete="on">
    <div id="login-msg" class="form-msg"></div>

    <button type="button" class="oauth-btn oauth-google" id="oauth-google">
      <svg viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92a5.06 5.06 0 0 1-2.2 3.32v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.1z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
      CONTINUE WITH GOOGLE
    </button>

    <button type="button" class="oauth-btn oauth-apple" id="oauth-apple-login">
      <svg viewBox="0 0 24 24"><path fill="#fff" d="M17.05 20.28c-.98.95-2.05.88-3.08.4-1.09-.5-2.08-.48-3.24 0-1.44.62-2.2.44-3.06-.4C2.79 15.25 3.51 7.59 9.05 7.31c1.35.07 2.29.74 3.08.8 1.18-.24 2.31-.93 3.57-.84 1.51.12 2.65.72 3.4 1.8-3.12 1.87-2.38 5.98.48 7.13-.57 1.5-1.31 2.99-2.54 4.09zM12.03 7.25c-.15-2.23 1.66-4.07 3.74-4.25.32 2.32-2.15 4.27-3.74 4.25z"/></svg>
      CONTINUE WITH APPLE
    </button>

    <div class="divider">or</div>

    <button type="button" class="email-toggle" id="login-email-toggle">Use email instead ▾</button>

    <div class="email-section" id="login-email-section">
      <div class="form-group">
        <label class="form-label" for="login-email">Email</label>
        <input class="form-input" id="login-email" type="email" placeholder="gladiator@arena.com" autocomplete="email" required>
      </div>

      <div class="form-group">
        <label class="form-label" for="login-password">Password</label>
        <input class="form-input" id="login-password" type="password" placeholder="••••••••" autocomplete="current-password" required>
      </div>

      <a href="#" class="forgot-link" id="forgot-link">Forgot password?</a>

      <button type="submit" class="btn-primary" id="login-btn">ENTER THE ARENA</button>
    </div>
  </form>

  <!-- SIGNUP FORM -->
  <form class="login-form" id="form-signup" autocomplete="on">
    <div id="signup-msg" class="form-msg"></div>

    <button type="button" class="oauth-btn oauth-google" id="oauth-google-signup">
      <svg viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92a5.06 5.06 0 0 1-2.2 3.32v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.1z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
      SIGN UP WITH GOOGLE
    </button>

    <button type="button" class="oauth-btn oauth-apple" id="oauth-apple-signup">
      <svg viewBox="0 0 24 24"><path fill="#fff" d="M17.05 20.28c-.98.95-2.05.88-3.08.4-1.09-.5-2.08-.48-3.24 0-1.44.62-2.2.44-3.06-.4C2.79 15.25 3.51 7.59 9.05 7.31c1.35.07 2.29.74 3.08.8 1.18-.24 2.31-.93 3.57-.84 1.51.12 2.65.72 3.4 1.8-3.12 1.87-2.38 5.98.48 7.13-.57 1.5-1.31 2.99-2.54 4.09zM12.03 7.25c-.15-2.23 1.66-4.07 3.74-4.25.32 2.32-2.15 4.27-3.74 4.25z"/></svg>
      SIGN UP WITH APPLE
    </button>

    <div class="divider">or</div>

    <button type="button" class="email-toggle" id="signup-email-toggle">Use email instead ▾</button>

    <div class="email-section" id="signup-email-section">
      <div class="form-group">
        <label class="form-label" for="signup-username">Username</label>
        <input class="form-input" id="signup-username" type="text" placeholder="gladiator42" autocomplete="username" minlength="3" maxlength="20" required>
      </div>

      <div class="form-group">
        <label class="form-label" for="signup-email">Email</label>
        <input class="form-input" id="signup-email" type="email" placeholder="gladiator@arena.com" autocomplete="email" required>
      </div>

      <div class="form-group">
        <label class="form-label" for="signup-password">Password</label>
        <input class="form-input" id="signup-password" type="password" placeholder="Min 8 characters" autocomplete="new-password" minlength="8" required>
      </div>

      <!-- Age Gate (Item 14.4.3) -->
      <div class="form-group">
        <label class="form-label">Date of Birth</label>
        <div class="dob-row">
          <select class="form-select" id="dob-month" required>
            <option value="" disabled selected>Month</option>
            <option value="1">Jan</option><option value="2">Feb</option><option value="3">Mar</option>
            <option value="4">Apr</option><option value="5">May</option><option value="6">Jun</option>
            <option value="7">Jul</option><option value="8">Aug</option><option value="9">Sep</option>
            <option value="10">Oct</option><option value="11">Nov</option><option value="12">Dec</option>
          </select>
          <select class="form-select" id="dob-day" required>
            <option value="" disabled selected>Day</option>
          </select>
          <select class="form-select" id="dob-year" required>
            <option value="" disabled selected>Year</option>
          </select>
        </div>
      </div>

      <!-- ToS Checkbox -->
      <div class="checkbox-row">
        <input type="checkbox" id="tos-check" required>
        <label for="tos-check">I agree to the <a href="colosseum-terms.html" target="_blank">Terms of Service</a> and am at least 13 years old.</label>
      </div>

      <button type="submit" class="btn-primary" id="signup-btn">CREATE ACCOUNT</button>
    </div>
  </form>
</div>

<div class="login-footer">
  <a href="colosseum-terms.html">Terms</a> · <a href="colosseum-terms.html#privacy">Privacy</a>
</div>

<!-- Password Reset Modal -->
<div class="modal-overlay" id="reset-modal">
  <div class="modal-card">
    <h3>RESET PASSWORD</h3>
    <p>Enter your email and we'll send a reset link.</p>
    <div id="reset-msg" class="form-msg"></div>
    <div class="form-group">
      <input class="form-input" id="reset-email" type="email" placeholder="Your email address">
    </div>
    <button class="btn-primary" id="reset-btn" style="font-size:14px;">SEND RESET LINK</button>
    <button class="modal-close" id="reset-close">Cancel</button>
  </div>
</div>

<!-- Set New Password Modal -->
<div class="modal-overlay" id="newpw-modal">
  <div class="modal-card">
    <h3>SET NEW PASSWORD</h3>
    <p>Enter your new password below.</p>
    <div id="newpw-msg" class="form-msg"></div>
    <div class="form-group">
      <label class="form-label" for="newpw-password">New Password</label>
      <input class="form-input" id="newpw-password" type="password" placeholder="Min 8 characters" autocomplete="new-password" minlength="8">
    </div>
    <div class="form-group">
      <label class="form-label" for="newpw-confirm">Confirm Password</label>
      <input class="form-input" id="newpw-confirm" type="password" placeholder="Type it again" autocomplete="new-password" minlength="8">
    </div>
    <button class="btn-primary" id="newpw-btn" style="font-size:14px;">UPDATE PASSWORD</button>
  </div>
</div>

<script>
// ============================================================
// LOGIN CONTROLLER — all logic preserved from original
// ============================================================

const isPlaceholder = typeof ColosseumConfig !== 'undefined' && ColosseumConfig.placeholderMode?.supabase;
if (isPlaceholder) {
  document.getElementById('placeholder-banner').style.display = 'block';
}

// Populate DOB selects
const daySelect = document.getElementById('dob-day');
for (let i = 1; i <= 31; i++) {
  const opt = document.createElement('option');
  opt.value = i; opt.textContent = i;
  daySelect.appendChild(opt);
}
const yearSelect = document.getElementById('dob-year');
const currentYear = new Date().getFullYear();
for (let y = currentYear - 10; y >= currentYear - 100; y--) {
  const opt = document.createElement('option');
  opt.value = y; opt.textContent = y;
  yearSelect.appendChild(opt);
}

// Tab switching
document.querySelectorAll('.login-tab').forEach(tab => {
  tab.addEventListener('click', () => {
    document.querySelectorAll('.login-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.login-form').forEach(f => f.classList.remove('active'));
    tab.classList.add('active');
    document.getElementById('form-' + tab.dataset.tab).classList.add('active');
  });
});

function showMsg(id, text, type) {
  const el = document.getElementById(id);
  el.className = 'form-msg ' + type;
  el.textContent = text;
}
function clearMsg(id) {
  const el = document.getElementById(id);
  el.className = 'form-msg'; el.textContent = '';
}

function getAge(month, day, year) {
  const today = new Date();
  const birth = new Date(year, month - 1, day);
  let age = today.getFullYear() - birth.getFullYear();
  const m = today.getMonth() - birth.getMonth();
  if (m < 0 || (m === 0 && today.getDate() < birth.getDate())) age--;
  return age;
}

// Rate Limiting (Item 14.4.1.16)
const loginAttempts = { count: 0, lastAttempt: 0, lockedUntil: 0 };
const MAX_ATTEMPTS = 5;
const LOCKOUT_MS = 60000;

function checkRateLimit() {
  const now = Date.now();
  if (now < loginAttempts.lockedUntil) {
    const secsLeft = Math.ceil((loginAttempts.lockedUntil - now) / 1000);
    return { allowed: false, message: `Too many attempts. Try again in ${secsLeft}s.` };
  }
  if (now - loginAttempts.lastAttempt > 300000) { loginAttempts.count = 0; }
  return { allowed: true };
}

function recordFailedAttempt() {
  loginAttempts.count++;
  loginAttempts.lastAttempt = Date.now();
  if (loginAttempts.count >= MAX_ATTEMPTS) {
    loginAttempts.lockedUntil = Date.now() + LOCKOUT_MS;
    loginAttempts.count = 0;
  }
}

// LOGIN
document.getElementById('form-login').addEventListener('submit', async (e) => {
  e.preventDefault();
  clearMsg('login-msg');
  const rateCheck = checkRateLimit();
  if (!rateCheck.allowed) { showMsg('login-msg', rateCheck.message, 'error'); return; }
  const email = document.getElementById('login-email').value.trim();
  const password = document.getElementById('login-password').value;
  if (!email || !password) { showMsg('login-msg', 'Please fill in all fields.', 'error'); return; }
  if (isPlaceholder) {
    showMsg('login-msg', 'Demo mode — entering the arena...', 'success');
    setTimeout(() => { window.location.href = 'index.html'; }, 800);
    return;
  }
  const btn = document.getElementById('login-btn');
  btn.disabled = true; btn.textContent = 'ENTERING...';
  try {
    const result = await ColosseumAuth.logIn({ email, password });
    if (!result.success) {
      recordFailedAttempt();
      showMsg('login-msg', result.error || 'Login failed.', 'error');
      btn.disabled = false; btn.textContent = 'ENTER THE ARENA';
    } else {
      showMsg('login-msg', 'Welcome back, gladiator.', 'success');
      setTimeout(() => { window.location.href = 'index.html'; }, 600);
    }
  } catch (err) {
    showMsg('login-msg', 'Something went wrong. Try again.', 'error');
    btn.disabled = false; btn.textContent = 'ENTER THE ARENA';
  }
});

// SIGNUP
document.getElementById('form-signup').addEventListener('submit', async (e) => {
  e.preventDefault();
  clearMsg('signup-msg');
  const username = document.getElementById('signup-username').value.trim();
  const email = document.getElementById('signup-email').value.trim();
  const password = document.getElementById('signup-password').value;
  const month = document.getElementById('dob-month').value;
  const day = document.getElementById('dob-day').value;
  const year = document.getElementById('dob-year').value;
  const tos = document.getElementById('tos-check').checked;
  if (!username || !email || !password || !month || !day || !year) { showMsg('signup-msg', 'Please fill in all fields.', 'error'); return; }
  if (username.length < 3 || username.length > 20) { showMsg('signup-msg', 'Username must be 3-20 characters.', 'error'); return; }
  if (!/^[a-zA-Z0-9_]+$/.test(username)) { showMsg('signup-msg', 'Username: letters, numbers, and underscores only.', 'error'); return; }
  if (password.length < 8) { showMsg('signup-msg', 'Password must be at least 8 characters.', 'error'); return; }
  if (!tos) { showMsg('signup-msg', 'You must agree to the Terms of Service.', 'error'); return; }
  const age = getAge(parseInt(month), parseInt(day), parseInt(year));
  if (age < 13) { showMsg('signup-msg', 'You must be at least 13 years old to use The Colosseum.', 'error'); return; }
  if (isPlaceholder) {
    showMsg('signup-msg', 'Demo mode — account created! Entering arena...', 'success');
    setTimeout(() => { window.location.href = 'index.html'; }, 800);
    return;
  }
  const btn = document.getElementById('signup-btn');
  btn.disabled = true; btn.textContent = 'CREATING...';
  try {
    const dob = `${year}-${String(month).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
    const result = await ColosseumAuth.signUp({ email, password, username, displayName: username, dob });
    if (!result.success) {
      showMsg('signup-msg', result.error || 'Signup failed.', 'error');
      btn.disabled = false; btn.textContent = 'CREATE ACCOUNT';
    } else {
      showMsg('signup-msg', 'Account created! Check your email to confirm.', 'success');
      setTimeout(() => { window.location.href = 'index.html'; }, 1200);
    }
  } catch (err) {
    showMsg('signup-msg', 'Something went wrong. Try again.', 'error');
    btn.disabled = false; btn.textContent = 'CREATE ACCOUNT';
  }
});

// Email section toggles
document.getElementById('login-email-toggle').addEventListener('click', function() {
  const section = document.getElementById('login-email-section');
  section.classList.toggle('open');
  this.textContent = section.classList.contains('open') ? 'Hide email login ▴' : 'Use email instead ▾';
});
document.getElementById('signup-email-toggle').addEventListener('click', function() {
  const section = document.getElementById('signup-email-section');
  section.classList.toggle('open');
  this.textContent = section.classList.contains('open') ? 'Hide email signup ▴' : 'Use email instead ▾';
});

// OAuth
function handleOAuth(provider) {
  if (isPlaceholder) {
    const formActive = document.querySelector('.login-form.active');
    const msgId = formActive.id === 'form-login' ? 'login-msg' : 'signup-msg';
    showMsg(msgId, `Demo mode — ${provider} OAuth not available without Supabase.`, 'error');
    return;
  }
  if (typeof ColosseumAuth !== 'undefined' && ColosseumAuth.oauthLogin) {
    ColosseumAuth.oauthLogin(provider);
  }
}
document.getElementById('oauth-google').addEventListener('click', () => handleOAuth('google'));
document.getElementById('oauth-apple-login').addEventListener('click', () => handleOAuth('apple'));
document.getElementById('oauth-google-signup').addEventListener('click', () => handleOAuth('google'));
document.getElementById('oauth-apple-signup').addEventListener('click', () => handleOAuth('apple'));

// Password Reset Modal
document.getElementById('forgot-link').addEventListener('click', (e) => {
  e.preventDefault();
  document.getElementById('reset-modal').classList.add('open');
  document.getElementById('reset-email').value = document.getElementById('login-email').value;
});
document.getElementById('reset-close').addEventListener('click', () => { document.getElementById('reset-modal').classList.remove('open'); });
document.getElementById('reset-modal').addEventListener('click', (e) => { if (e.target === e.currentTarget) e.currentTarget.classList.remove('open'); });

document.getElementById('reset-btn').addEventListener('click', async () => {
  const email = document.getElementById('reset-email').value.trim();
  if (!email) { showMsg('reset-msg', 'Enter your email.', 'error'); return; }
  if (isPlaceholder) { showMsg('reset-msg', 'Demo mode — no email sent.', 'error'); return; }
  try {
    await ColosseumAuth.resetPassword(email);
    showMsg('reset-msg', 'Reset link sent! Check your inbox.', 'success');
  } catch { showMsg('reset-msg', 'Could not send reset link.', 'error'); }
});

// Set New Password
document.getElementById('newpw-btn').addEventListener('click', async () => {
  const pw = document.getElementById('newpw-password').value;
  const confirm = document.getElementById('newpw-confirm').value;
  if (!pw || pw.length < 8) { showMsg('newpw-msg', 'Password must be at least 8 characters.', 'error'); return; }
  if (pw !== confirm) { showMsg('newpw-msg', 'Passwords do not match.', 'error'); return; }
  const btn = document.getElementById('newpw-btn');
  btn.disabled = true; btn.textContent = 'UPDATING...';
  try {
    const result = await ColosseumAuth.updatePassword(pw);
    if (!result.success) {
      showMsg('newpw-msg', result.error || 'Could not update password.', 'error');
      btn.disabled = false; btn.textContent = 'UPDATE PASSWORD';
    } else {
      showMsg('newpw-msg', '✅ Password updated! Entering the arena...', 'success');
      setTimeout(() => { window.location.href = 'index.html'; }, 1200);
    }
  } catch (err) {
    showMsg('newpw-msg', 'Something went wrong. Try again.', 'error');
    btn.disabled = false; btn.textContent = 'UPDATE PASSWORD';
  }
});

// Auto-redirect if already logged in + handle email confirm / recovery
window.addEventListener('DOMContentLoaded', () => {
  if (!isPlaceholder && typeof ColosseumAuth !== 'undefined' && ColosseumAuth.supabase) {
    ColosseumAuth.supabase.auth.onAuthStateChange((event, session) => {
      if (event === 'PASSWORD_RECOVERY') {
        document.getElementById('newpw-modal').classList.add('open');
      } else if (event === 'SIGNED_IN' && session?.user) {
        const hash = window.location.hash;
        if (hash && (hash.includes('type=signup') || hash.includes('type=email'))) {
          showMsg('login-msg', '✅ Email confirmed! Entering the arena...', 'success');
          setTimeout(() => { window.location.href = 'index.html'; }, 1200);
        }
      }
    });
  }

  const hash = window.location.hash;
  if (hash && hash.includes('access_token')) {
    const params = new URLSearchParams(hash.substring(1));
    const type = params.get('type');
    if (type === 'signup' || type === 'email') {
      showMsg('login-msg', '✅ Email confirmed! Entering the arena...', 'success');
      setTimeout(() => { window.location.href = 'index.html'; }, 1200);
      return;
    }
    if (type === 'recovery') { return; }
  }

  if (typeof ColosseumAuth !== 'undefined' && ColosseumAuth.currentUser && !isPlaceholder) {
    window.location.href = 'index.html';
  }
});
</script>
</body>
</html>
