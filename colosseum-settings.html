<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#0a1628">
<title>Settings ‚Äî The Colosseum</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="colosseum-config.js"></script>
<script src="colosseum-auth.js"></script>

<style>
  @import url('https://fonts.googleapis.com/css2?family=Cinzel:wght@600;700;900&family=Barlow+Condensed:wght@400;600;700&display=swap');

  :root {
    --navy: #0a1628;
    --navy-light: #132240;
    --navy-mid: #1a2d4a;
    --red: #c1272d;
    --red-hover: #e63946;
    --gold: #d4a843;
    --gold-dim: #b8922e;
    --white: #f0ece2;
    --white-dim: #a0a8b8;
    --error: #e74c3c;
    --success: #2ecc71;
    --font-display: 'Cinzel', serif;
    --font-body: 'Barlow Condensed', sans-serif;
    --safe-top: env(safe-area-inset-top, 0px);
    --safe-bottom: env(safe-area-inset-bottom, 0px);
  }

  *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: var(--font-body);
    background: linear-gradient(145deg, #1a2d4a 0%, #2d5a8e 25%, #5b8abf 50%, #7aa3d4 75%, #3d5a80 100%);
    color: var(--white);
    min-height: 100dvh;
    padding: calc(16px + var(--safe-top)) 16px calc(80px + var(--safe-bottom));
    -webkit-font-smoothing: antialiased;
  }

  /* === BACK NAV === */
  .back-bar {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 20px;
  }
  .back-btn {
    min-width: 44px;
    min-height: 44px;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(10, 17, 40, 0.5);
    backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
    border: 1px solid rgba(255,255,255,0.2);
    border-radius: 16px;
    color: var(--white);
    font-size: 20px;
    text-decoration: none;
    -webkit-tap-highlight-color: transparent;
  }
  .back-btn:active { background: var(--navy-mid); }

  .page-title {
    font-family: var(--font-display);
    font-size: 24px;
    letter-spacing: 3px;
  }

  /* === SECTIONS === */
  .settings-section {
    margin-bottom: 24px;
  }
  .section-label {
    font-family: var(--font-display);
    font-size: 14px;
    letter-spacing: 2px;
    color: var(--gold);
    margin-bottom: 10px;
    padding-left: 2px;
  }

  .settings-card {
    background: rgba(10, 17, 40, 0.6);
    backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);
    border: 1.5px solid rgba(255,255,255,0.2);
    border-radius: 16px;
    overflow: hidden;
    box-shadow: 0 0 0 1px rgba(0,0,0,0.3), 0 8px 32px rgba(0,0,0,0.25);
  }

  /* === ROW === */
  .settings-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    min-height: 50px;
    padding: 12px 16px;
    border-bottom: 1px solid rgba(255,255,255,0.1);
  }
  .settings-row:last-child { border-bottom: none; }

  .row-left {
    display: flex;
    flex-direction: column;
    gap: 2px;
    flex: 1;
    min-width: 0;
  }
  .row-label {
    font-size: 15px;
    font-weight: 600;
  }
  .row-desc {
    font-size: 12px;
    color: var(--white-dim);
  }

  /* === TOGGLE === */
  .toggle {
    position: relative;
    width: 48px; height: 28px;
    flex-shrink: 0;
    margin-left: 12px;
  }
  .toggle input { opacity: 0; width: 0; height: 0; }
  .toggle-track {
    position: absolute;
    inset: 0;
    background: var(--navy-mid);
    border-radius: 14px;
    cursor: pointer;
    transition: background 0.25s;
  }
  .toggle-track::after {
    content: '';
    position: absolute;
    top: 3px; left: 3px;
    width: 22px; height: 22px;
    background: var(--white-dim);
    border-radius: 50%;
    transition: transform 0.25s, background 0.25s;
  }
  .toggle input:checked + .toggle-track { background: var(--gold-dim); }
  .toggle input:checked + .toggle-track::after {
    transform: translateX(20px);
    background: var(--white);
  }

  /* === INPUT === */
  .settings-input {
    background: rgba(10,17,40,0.6);
    border: 1px solid rgba(255,255,255,0.15);
    border-radius: 14px;
    padding: 8px 12px;
    color: var(--white);
    font-family: var(--font-body);
    font-size: 15px;
    width: 180px;
    text-align: right;
    outline: none;
    flex-shrink: 0;
    margin-left: 12px;
  }
  .settings-input:focus { border-color: var(--gold-dim); }

  /* === TIER BADGE === */
  .tier-badge {
    display: inline-block;
    padding: 4px 12px;
    border-radius: 6px;
    font-family: var(--font-display);
    font-size: 14px;
    letter-spacing: 2px;
    background: var(--navy-mid);
    color: var(--white-dim);
  }
  .tier-badge.contender { background: rgba(212,168,67,0.15); color: var(--gold); }
  .tier-badge.champion { background: rgba(212,168,67,0.25); color: var(--gold); border: 1px solid var(--gold-dim); }
  .tier-badge.creator { background: linear-gradient(135deg, rgba(212,168,67,0.3), rgba(204,41,54,0.2)); color: var(--gold); }

  /* === BUTTONS === */
  .settings-btn {
    width: 100%;
    min-height: 48px;
    padding: 12px;
    border: none;
    border-radius: 14px;
    font-family: var(--font-display);
    font-size: 16px;
    letter-spacing: 2px;
    cursor: pointer;
    -webkit-tap-highlight-color: transparent;
    margin-bottom: 10px;
  }
  .settings-btn.outline {
    background: transparent;
    color: var(--white-dim);
    border: 1px solid rgba(255,255,255,0.1);
  }
  .settings-btn.outline:active { background: var(--navy-mid); }
  .settings-btn.danger {
    background: transparent;
    color: var(--error);
    border: 1px solid rgba(231,76,60,0.3);
  }
  .settings-btn.danger:active { background: rgba(231,76,60,0.1); }

  /* === CONFIRM MODAL === */
  .modal-overlay {
    position: fixed; inset: 0;
    background: rgba(0,0,0,0.7);
    display: none; align-items: center; justify-content: center;
    padding: 16px;
    z-index: 9999;
  }
  .modal-overlay.open { display: flex; }
  .modal-card {
    background: var(--navy-light);
    border: 1px solid rgba(231,76,60,0.3);
    border-radius: 14px;
    padding: 24px 20px;
    width: 100%;
    max-width: 360px;
    text-align: center;
  }
  .modal-card h3 {
    font-family: var(--font-display);
    font-size: 20px;
    letter-spacing: 2px;
    color: var(--error);
    margin-bottom: 8px;
  }
  .modal-card p {
    font-size: 14px;
    color: var(--white-dim);
    margin-bottom: 20px;
  }
  .modal-actions { display: flex; gap: 10px; }
  .modal-actions button { flex: 1; min-height: 44px; border-radius: 8px; border: none; font-size: 15px; font-weight: 700; cursor: pointer; }
  .modal-cancel { background: var(--navy-mid); color: var(--white-dim); }
  .modal-confirm { background: var(--error); color: #fff; }

  /* === TOAST === */
  .toast {
    position: fixed;
    bottom: 90px; left: 50%; transform: translateX(-50%);
    background: var(--success);
    color: #fff;
    padding: 10px 20px;
    border-radius: 8px;
    font-weight: 700;
    font-size: 14px;
    z-index: 9999;
    opacity: 0;
    transition: opacity 0.3s;
    pointer-events: none;
  }
  .toast.show { opacity: 1; }

  .version-text {
    text-align: center;
    font-size: 12px;
    color: rgba(160,168,184,0.4);
    margin-top: 20px;
  }
</style>
</head>
<body>

<!-- Back bar -->
<div class="back-bar">
  <a href="index.html" class="back-btn">‚Üê</a>
  <div class="page-title">SETTINGS</div>
</div>

<!-- ACCOUNT -->
<div class="settings-section">
  <div class="section-label">ACCOUNT</div>
  <div class="settings-card">
    <div class="settings-row">
      <div class="row-left">
        <div class="row-label">Display Name</div>
      </div>
      <input class="settings-input" id="set-display-name" type="text" placeholder="Gladiator" maxlength="30">
    </div>
    <div class="settings-row">
      <div class="row-left">
        <div class="row-label">Username</div>
      </div>
      <input class="settings-input" id="set-username" type="text" placeholder="gladiator42" maxlength="20" style="color:var(--white-dim);">
    </div>
    <div class="settings-row">
      <div class="row-left">
        <div class="row-label">Email</div>
        <div class="row-desc" id="set-email-display">‚Äî</div>
      </div>
    </div>
    <div class="settings-row">
      <div class="row-left">
        <div class="row-label">Subscription</div>
      </div>
      <span class="tier-badge" id="set-tier-badge">FREE</span>
    </div>
  </div>
</div>

<!-- NOTIFICATIONS -->
<div class="settings-section">
  <div class="section-label">NOTIFICATIONS</div>
  <div class="settings-card">
    <div class="settings-row">
      <div class="row-left">
        <div class="row-label">Challenge Alerts</div>
        <div class="row-desc">When someone challenges you</div>
      </div>
      <label class="toggle"><input type="checkbox" id="set-notif-challenge" checked><span class="toggle-track"></span></label>
    </div>
    <div class="settings-row">
      <div class="row-left">
        <div class="row-label">Debate Reminders</div>
        <div class="row-desc">Upcoming scheduled debates</div>
      </div>
      <label class="toggle"><input type="checkbox" id="set-notif-debate" checked><span class="toggle-track"></span></label>
    </div>
    <div class="settings-row">
      <div class="row-left">
        <div class="row-label">Follower Activity</div>
        <div class="row-desc">When people you follow debate</div>
      </div>
      <label class="toggle"><input type="checkbox" id="set-notif-follow" checked><span class="toggle-track"></span></label>
    </div>
    <div class="settings-row">
      <div class="row-left">
        <div class="row-label">Hot Take Reactions</div>
        <div class="row-desc">When your takes get reactions</div>
      </div>
      <label class="toggle"><input type="checkbox" id="set-notif-reactions" checked><span class="toggle-track"></span></label>
    </div>
  </div>
</div>

<!-- AUDIO -->
<div class="settings-section">
  <div class="section-label">AUDIO</div>
  <div class="settings-card">
    <div class="settings-row">
      <div class="row-left">
        <div class="row-label">Sound Effects</div>
        <div class="row-desc">Fight sounds, notifications</div>
      </div>
      <label class="toggle"><input type="checkbox" id="set-audio-sfx" checked><span class="toggle-track"></span></label>
    </div>
    <div class="settings-row">
      <div class="row-left">
        <div class="row-label">Auto-Mute Mic</div>
        <div class="row-desc">Start debates with mic muted</div>
      </div>
      <label class="toggle"><input type="checkbox" id="set-audio-mute"><span class="toggle-track"></span></label>
    </div>
  </div>
</div>

<!-- PRIVACY -->
<div class="settings-section">
  <div class="section-label">PRIVACY</div>
  <div class="settings-card">
    <div class="settings-row">
      <div class="row-left">
        <div class="row-label">Public Profile</div>
        <div class="row-desc">Others can see your stats</div>
      </div>
      <label class="toggle"><input type="checkbox" id="set-privacy-public" checked><span class="toggle-track"></span></label>
    </div>
    <div class="settings-row">
      <div class="row-left">
        <div class="row-label">Show Online Status</div>
      </div>
      <label class="toggle"><input type="checkbox" id="set-privacy-online" checked><span class="toggle-track"></span></label>
    </div>
    <div class="settings-row">
      <div class="row-left">
        <div class="row-label">Allow Challenges</div>
        <div class="row-desc">Anyone can challenge you</div>
      </div>
      <label class="toggle"><input type="checkbox" id="set-privacy-challenges" checked><span class="toggle-track"></span></label>
    </div>
  </div>
</div>

<!-- ACTIONS -->
<div class="settings-section">
  <button class="settings-btn outline" id="save-btn">üíæ SAVE CHANGES</button>
  <button class="settings-btn outline" onclick="window.location.href='index.html'">‚Üê BACK TO ARENA</button>
  <button class="settings-btn outline" id="logout-btn">üö™ LOG OUT</button>
  <button class="settings-btn danger" id="delete-btn">üóëÔ∏è DELETE ACCOUNT</button>
</div>

<div class="version-text">The Colosseum v2.0.0</div>

<!-- Delete Confirmation Modal -->
<div class="modal-overlay" id="delete-modal">
  <div class="modal-card">
    <h3>‚ö†Ô∏è DELETE ACCOUNT</h3>
    <p>This is permanent. All your data, stats, and cosmetics will be gone forever. There is no undo.</p>
    <div class="modal-actions">
      <button class="modal-cancel" id="delete-cancel">CANCEL</button>
      <button class="modal-confirm" id="delete-confirm">DELETE</button>
    </div>
  </div>
</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<script>
const isPlaceholder = typeof ColosseumConfig !== 'undefined' && ColosseumConfig.placeholderMode?.supabase;

function toast(msg) {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.classList.add('show');
  setTimeout(() => el.classList.remove('show'), 2500);
}

// --- Load saved settings from localStorage ---
function loadSettings() {
  const saved = JSON.parse(localStorage.getItem('colosseum_settings') || '{}');

  // Account fields
  document.getElementById('set-display-name').value = saved.display_name || '';
  document.getElementById('set-username').value = saved.username || '';
  document.getElementById('set-email-display').textContent = saved.email || '‚Äî';

  // Tier badge
  const tier = saved.subscription_tier || 'free';
  const badge = document.getElementById('set-tier-badge');
  const labels = { free: 'FREE', contender: 'CONTENDER', champion: 'CHAMPION', creator: 'CREATOR' };
  badge.textContent = labels[tier] || 'FREE';
  badge.className = 'tier-badge ' + (tier !== 'free' ? tier : '');

  // Toggles
  const toggleMap = {
    'set-notif-challenge': saved.notif_challenge !== false,
    'set-notif-debate': saved.notif_debate !== false,
    'set-notif-follow': saved.notif_follow !== false,
    'set-notif-reactions': saved.notif_reactions !== false,
    'set-audio-sfx': saved.audio_sfx !== false,
    'set-audio-mute': saved.audio_mute === true,
    'set-privacy-public': saved.privacy_public !== false,
    'set-privacy-online': saved.privacy_online !== false,
    'set-privacy-challenges': saved.privacy_challenges !== false,
  };
  for (const [id, val] of Object.entries(toggleMap)) {
    const el = document.getElementById(id);
    if (el) el.checked = val;
  }

  // If auth module has a profile, use that
  if (typeof ColosseumAuth !== 'undefined' && ColosseumAuth.currentProfile) {
    const p = ColosseumAuth.currentProfile;
    document.getElementById('set-display-name').value = p.display_name || saved.display_name || '';
    document.getElementById('set-username').value = p.username || saved.username || '';
    document.getElementById('set-email-display').textContent = ColosseumAuth.currentUser?.email || saved.email || '‚Äî';
    const t = p.subscription_tier || 'free';
    badge.textContent = labels[t] || 'FREE';
    badge.className = 'tier-badge ' + (t !== 'free' ? t : '');
  }
}

// --- Save ---
function saveSettings() {
  const settings = {
    display_name: document.getElementById('set-display-name').value.trim(),
    username: document.getElementById('set-username').value.trim(),
    email: document.getElementById('set-email-display').textContent,
    notif_challenge: document.getElementById('set-notif-challenge').checked,
    notif_debate: document.getElementById('set-notif-debate').checked,
    notif_follow: document.getElementById('set-notif-follow').checked,
    notif_reactions: document.getElementById('set-notif-reactions').checked,
    audio_sfx: document.getElementById('set-audio-sfx').checked,
    audio_mute: document.getElementById('set-audio-mute').checked,
    privacy_public: document.getElementById('set-privacy-public').checked,
    privacy_online: document.getElementById('set-privacy-online').checked,
    privacy_challenges: document.getElementById('set-privacy-challenges').checked,
  };

  localStorage.setItem('colosseum_settings', JSON.stringify(settings));

  // If auth module is live, also save to Supabase
  if (typeof ColosseumAuth !== 'undefined' && ColosseumAuth.updateProfile && !isPlaceholder) {
    ColosseumAuth.updateProfile({
      display_name: settings.display_name,
      username: settings.username,
    }).catch(() => {});

    // Save settings to user_settings table if method exists
    if (ColosseumAuth.updateProfile) {
      ColosseumAuth.updateProfile(settings).catch(() => {});
    }
  }

  toast('‚úÖ Settings saved');
}

document.getElementById('save-btn').addEventListener('click', saveSettings);

// --- Logout ---
document.getElementById('logout-btn').addEventListener('click', async () => {
  if (typeof ColosseumAuth !== 'undefined' && ColosseumAuth.logOut) {
    await ColosseumAuth.logOut();
  }
  localStorage.removeItem('colosseum_settings');
  window.location.href = 'colosseum-login.html';
});

// --- Delete Account ---
document.getElementById('delete-btn').addEventListener('click', () => {
  document.getElementById('delete-modal').classList.add('open');
});
document.getElementById('delete-cancel').addEventListener('click', () => {
  document.getElementById('delete-modal').classList.remove('open');
});
document.getElementById('delete-modal').addEventListener('click', (e) => {
  if (e.target === e.currentTarget) e.currentTarget.classList.remove('open');
});
document.getElementById('delete-confirm').addEventListener('click', async () => {
  if (typeof ColosseumAuth !== 'undefined' && ColosseumAuth.deleteAccount && !isPlaceholder) {
    await ColosseumAuth.deleteAccount();
  }
  localStorage.clear();
  window.location.href = 'colosseum-login.html';
});

// --- Init ---
window.addEventListener('DOMContentLoaded', loadSettings);
</script>
</body>
</html>
