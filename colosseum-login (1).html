<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="theme-color" content="#0a1628">
<title>The Colosseum — Enter the Arena</title>

<!-- Supabase CDN -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="colosseum-config.js"></script>
<script src="colosseum-auth.js"></script>

<style>
  @import url('https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Source+Sans+3:wght@400;600;700&display=swap');

  :root {
    --navy: #0a1628;
    --navy-light: #132240;
    --navy-mid: #1a2d4a;
    --red: #cc2936;
    --red-hover: #e63946;
    --gold: #d4a843;
    --gold-dim: #b8922e;
    --white: #f0f0f0;
    --white-dim: #a0a8b8;
    --error: #e74c3c;
    --success: #2ecc71;
    --font-display: 'Bebas Neue', sans-serif;
    --font-body: 'Source Sans 3', sans-serif;
    --safe-top: env(safe-area-inset-top, 0px);
    --safe-bottom: env(safe-area-inset-bottom, 0px);
  }

  *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: var(--font-body);
    background: var(--navy);
    color: var(--white);
    min-height: 100dvh;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: calc(16px + var(--safe-top)) 16px calc(16px + var(--safe-bottom));
    overflow-y: auto;
    -webkit-font-smoothing: antialiased;
  }

  /* === PLACEHOLDER BANNER === */
  .placeholder-banner {
    position: fixed;
    top: 0; left: 0; right: 0;
    background: linear-gradient(135deg, var(--gold-dim), var(--gold));
    color: var(--navy);
    text-align: center;
    padding: 8px 16px;
    font-size: 12px;
    font-weight: 700;
    z-index: 9999;
    letter-spacing: 0.5px;
  }

  /* === LOGO === */
  .login-logo {
    font-family: var(--font-display);
    font-size: clamp(36px, 10vw, 56px);
    letter-spacing: 4px;
    text-align: center;
    margin-bottom: 4px;
    line-height: 1;
  }
  .login-logo span { color: var(--gold); }

  .login-tagline {
    font-size: 13px;
    color: var(--white-dim);
    text-align: center;
    margin-bottom: 28px;
    letter-spacing: 1px;
  }

  /* === CARD === */
  .login-card {
    width: 100%;
    max-width: 400px;
    background: var(--navy-light);
    border: 1px solid rgba(212,168,67,0.12);
    border-radius: 14px;
    padding: 24px 20px;
  }

  /* === TABS === */
  .login-tabs {
    display: flex;
    gap: 0;
    margin-bottom: 20px;
    border-bottom: 2px solid rgba(255,255,255,0.06);
  }
  .login-tab {
    flex: 1;
    background: none;
    border: none;
    color: var(--white-dim);
    font-family: var(--font-display);
    font-size: 18px;
    letter-spacing: 3px;
    padding: 10px 0;
    cursor: pointer;
    position: relative;
    -webkit-tap-highlight-color: transparent;
  }
  .login-tab.active { color: var(--gold); }
  .login-tab.active::after {
    content: '';
    position: absolute;
    bottom: -2px; left: 0; right: 0;
    height: 2px;
    background: var(--gold);
  }

  /* === FORMS === */
  .login-form { display: none; }
  .login-form.active { display: block; }

  .form-group { margin-bottom: 14px; }

  .form-label {
    display: block;
    font-size: 12px;
    font-weight: 600;
    color: var(--white-dim);
    text-transform: uppercase;
    letter-spacing: 1px;
    margin-bottom: 6px;
  }

  .form-input {
    width: 100%;
    min-height: 44px;
    padding: 10px 14px;
    background: var(--navy);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 8px;
    color: var(--white);
    font-family: var(--font-body);
    font-size: 16px; /* prevents iOS zoom */
    outline: none;
    -webkit-tap-highlight-color: transparent;
    transition: border-color 0.2s;
  }
  .form-input:focus { border-color: var(--gold-dim); }
  .form-input::placeholder { color: rgba(160,168,184,0.5); }

  .form-input.error { border-color: var(--error); }

  /* DOB row */
  .dob-row {
    display: grid;
    grid-template-columns: 1fr 1fr 1fr;
    gap: 8px;
  }

  .form-select {
    width: 100%;
    min-height: 44px;
    padding: 10px 8px;
    background: var(--navy);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 8px;
    color: var(--white);
    font-family: var(--font-body);
    font-size: 15px;
    outline: none;
    -webkit-appearance: none;
    cursor: pointer;
  }
  .form-select:focus { border-color: var(--gold-dim); }

  /* === CHECKBOX === */
  .checkbox-row {
    display: flex;
    align-items: flex-start;
    gap: 10px;
    margin: 16px 0;
  }
  .checkbox-row input[type="checkbox"] {
    width: 20px; height: 20px;
    margin-top: 2px;
    accent-color: var(--gold);
    flex-shrink: 0;
  }
  .checkbox-row label {
    font-size: 13px;
    color: var(--white-dim);
    line-height: 1.4;
  }
  .checkbox-row a { color: var(--gold); text-decoration: none; }
  .checkbox-row a:hover { text-decoration: underline; }

  /* === BUTTONS === */
  .btn-primary {
    width: 100%;
    min-height: 48px;
    padding: 12px;
    background: var(--red);
    color: #fff;
    border: none;
    border-radius: 8px;
    font-family: var(--font-display);
    font-size: 18px;
    letter-spacing: 3px;
    cursor: pointer;
    -webkit-tap-highlight-color: transparent;
    transition: background 0.2s;
  }
  .btn-primary:active { background: var(--red-hover); }
  .btn-primary:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  /* === DIVIDER === */
  .divider {
    display: flex;
    align-items: center;
    gap: 12px;
    margin: 18px 0;
    color: var(--white-dim);
    font-size: 12px;
    text-transform: uppercase;
    letter-spacing: 1px;
  }
  .divider::before, .divider::after {
    content: '';
    flex: 1;
    height: 1px;
    background: rgba(255,255,255,0.08);
  }

  /* === OAUTH === */
  .oauth-btn {
    width: 100%;
    min-height: 44px;
    padding: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 10px;
    background: var(--navy);
    border: 1px solid rgba(255,255,255,0.12);
    border-radius: 8px;
    color: var(--white);
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
    -webkit-tap-highlight-color: transparent;
    margin-bottom: 8px;
    transition: border-color 0.2s;
  }
  .oauth-btn:active { background: var(--navy-mid); }
  .oauth-btn svg { width: 20px; height: 20px; flex-shrink: 0; }

  /* === ERROR / SUCCESS MSG === */
  .form-msg {
    padding: 10px 14px;
    border-radius: 8px;
    font-size: 14px;
    margin-bottom: 14px;
    display: none;
  }
  .form-msg.error { display: block; background: rgba(231,76,60,0.15); color: var(--error); border: 1px solid rgba(231,76,60,0.3); }
  .form-msg.success { display: block; background: rgba(46,204,113,0.15); color: var(--success); border: 1px solid rgba(46,204,113,0.3); }

  /* === FORGOT PASSWORD === */
  .forgot-link {
    display: block;
    text-align: right;
    font-size: 13px;
    color: var(--gold);
    text-decoration: none;
    margin-top: -6px;
    margin-bottom: 14px;
  }

  /* === FOOTER === */
  .login-footer {
    text-align: center;
    margin-top: 20px;
    font-size: 12px;
    color: var(--white-dim);
  }
  .login-footer a { color: var(--gold); text-decoration: none; }

  /* === RESET MODAL === */
  .modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.7);
    display: none;
    align-items: center;
    justify-content: center;
    padding: 16px;
    z-index: 9999;
  }
  .modal-overlay.open { display: flex; }

  .modal-card {
    background: var(--navy-light);
    border: 1px solid rgba(212,168,67,0.2);
    border-radius: 14px;
    padding: 24px 20px;
    width: 100%;
    max-width: 380px;
  }
  .modal-card h3 {
    font-family: var(--font-display);
    font-size: 20px;
    letter-spacing: 2px;
    margin-bottom: 8px;
  }
  .modal-card p {
    font-size: 14px;
    color: var(--white-dim);
    margin-bottom: 16px;
  }
  .modal-close {
    margin-top: 10px;
    background: none;
    border: 1px solid rgba(255,255,255,0.1);
    color: var(--white-dim);
    padding: 10px;
    border-radius: 8px;
    width: 100%;
    font-size: 14px;
    cursor: pointer;
  }
</style>
</head>
<body>

<!-- Placeholder banner -->
<div class="placeholder-banner" id="placeholder-banner" style="display:none;">
  ⚡ DEMO MODE — No Supabase connected. See colosseum-config.js
</div>

<!-- Logo -->
<div class="login-logo">THE <span>COLOSSEUM</span></div>
<div class="login-tagline">Where opinions fight.</div>

<!-- Login Card -->
<div class="login-card">

  <!-- Tabs -->
  <div class="login-tabs">
    <button class="login-tab active" data-tab="login">LOG IN</button>
    <button class="login-tab" data-tab="signup">SIGN UP</button>
  </div>

  <!-- ===== LOGIN FORM ===== -->
  <form class="login-form active" id="form-login" autocomplete="on">
    <div id="login-msg" class="form-msg"></div>

    <div class="form-group">
      <label class="form-label" for="login-email">Email</label>
      <input class="form-input" id="login-email" type="email" placeholder="gladiator@arena.com" autocomplete="email" required>
    </div>

    <div class="form-group">
      <label class="form-label" for="login-password">Password</label>
      <input class="form-input" id="login-password" type="password" placeholder="••••••••" autocomplete="current-password" required>
    </div>

    <a href="#" class="forgot-link" id="forgot-link">Forgot password?</a>

    <button type="submit" class="btn-primary" id="login-btn">ENTER THE ARENA</button>

    <div class="divider">or continue with</div>

    <button type="button" class="oauth-btn" id="oauth-google">
      <svg viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92a5.06 5.06 0 0 1-2.2 3.32v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.1z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
      Continue with Google
    </button>

    <button type="button" class="oauth-btn" id="oauth-apple-login">
      <svg viewBox="0 0 24 24"><path fill="#fff" d="M17.05 20.28c-.98.95-2.05.88-3.08.4-1.09-.5-2.08-.48-3.24 0-1.44.62-2.2.44-3.06-.4C2.79 15.25 3.51 7.59 9.05 7.31c1.35.07 2.29.74 3.08.8 1.18-.24 2.31-.93 3.57-.84 1.51.12 2.65.72 3.4 1.8-3.12 1.87-2.38 5.98.48 7.13-.57 1.5-1.31 2.99-2.54 4.09zM12.03 7.25c-.15-2.23 1.66-4.07 3.74-4.25.32 2.32-2.15 4.27-3.74 4.25z"/></svg>
      Continue with Apple
    </button>
  </form>

  <!-- ===== SIGNUP FORM ===== -->
  <form class="login-form" id="form-signup" autocomplete="on">
    <div id="signup-msg" class="form-msg"></div>

    <div class="form-group">
      <label class="form-label" for="signup-username">Username</label>
      <input class="form-input" id="signup-username" type="text" placeholder="gladiator42" autocomplete="username" minlength="3" maxlength="20" required>
    </div>

    <div class="form-group">
      <label class="form-label" for="signup-email">Email</label>
      <input class="form-input" id="signup-email" type="email" placeholder="gladiator@arena.com" autocomplete="email" required>
    </div>

    <div class="form-group">
      <label class="form-label" for="signup-password">Password</label>
      <input class="form-input" id="signup-password" type="password" placeholder="Min 8 characters" autocomplete="new-password" minlength="8" required>
    </div>

    <!-- Age Gate (Item 14.4.3) -->
    <div class="form-group">
      <label class="form-label">Date of Birth</label>
      <div class="dob-row">
        <select class="form-select" id="dob-month" required>
          <option value="" disabled selected>Month</option>
          <option value="1">Jan</option><option value="2">Feb</option><option value="3">Mar</option>
          <option value="4">Apr</option><option value="5">May</option><option value="6">Jun</option>
          <option value="7">Jul</option><option value="8">Aug</option><option value="9">Sep</option>
          <option value="10">Oct</option><option value="11">Nov</option><option value="12">Dec</option>
        </select>
        <select class="form-select" id="dob-day" required>
          <option value="" disabled selected>Day</option>
        </select>
        <select class="form-select" id="dob-year" required>
          <option value="" disabled selected>Year</option>
        </select>
      </div>
    </div>

    <!-- ToS Checkbox (Item 14.4.2.5) -->
    <div class="checkbox-row">
      <input type="checkbox" id="tos-check" required>
      <label for="tos-check">I agree to the <a href="colosseum-terms.html" target="_blank">Terms of Service</a> and am at least 13 years old.</label>
    </div>

    <button type="submit" class="btn-primary" id="signup-btn">CREATE ACCOUNT</button>

    <div class="divider">or continue with</div>

    <button type="button" class="oauth-btn" id="oauth-google-signup">
      <svg viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92a5.06 5.06 0 0 1-2.2 3.32v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.1z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
      Continue with Google
    </button>

    <button type="button" class="oauth-btn" id="oauth-apple-signup">
      <svg viewBox="0 0 24 24"><path fill="#fff" d="M17.05 20.28c-.98.95-2.05.88-3.08.4-1.09-.5-2.08-.48-3.24 0-1.44.62-2.2.44-3.06-.4C2.79 15.25 3.51 7.59 9.05 7.31c1.35.07 2.29.74 3.08.8 1.18-.24 2.31-.93 3.57-.84 1.51.12 2.65.72 3.4 1.8-3.12 1.87-2.38 5.98.48 7.13-.57 1.5-1.31 2.99-2.54 4.09zM12.03 7.25c-.15-2.23 1.66-4.07 3.74-4.25.32 2.32-2.15 4.27-3.74 4.25z"/></svg>
      Continue with Apple
    </button>
  </form>
</div>

<div class="login-footer">
  <a href="colosseum-terms.html">Terms</a> · <a href="colosseum-terms.html#privacy">Privacy</a>
</div>

<!-- Password Reset Modal -->
<div class="modal-overlay" id="reset-modal">
  <div class="modal-card">
    <h3>RESET PASSWORD</h3>
    <p>Enter your email and we'll send a reset link.</p>
    <div id="reset-msg" class="form-msg"></div>
    <div class="form-group">
      <input class="form-input" id="reset-email" type="email" placeholder="Your email address">
    </div>
    <button class="btn-primary" id="reset-btn" style="font-size:16px;">SEND RESET LINK</button>
    <button class="modal-close" id="reset-close">Cancel</button>
  </div>
</div>

<!-- Set New Password Modal (shown after clicking reset link in email) -->
<div class="modal-overlay" id="newpw-modal">
  <div class="modal-card">
    <h3>SET NEW PASSWORD</h3>
    <p>Enter your new password below.</p>
    <div id="newpw-msg" class="form-msg"></div>
    <div class="form-group">
      <label class="form-label" for="newpw-password">New Password</label>
      <input class="form-input" id="newpw-password" type="password" placeholder="Min 8 characters" autocomplete="new-password" minlength="8">
    </div>
    <div class="form-group">
      <label class="form-label" for="newpw-confirm">Confirm Password</label>
      <input class="form-input" id="newpw-confirm" type="password" placeholder="Type it again" autocomplete="new-password" minlength="8">
    </div>
    <button class="btn-primary" id="newpw-btn" style="font-size:16px;">UPDATE PASSWORD</button>
  </div>
</div>

<script>
// ============================================================
// LOGIN CONTROLLER
// ============================================================

// --- Placeholder mode check ---
const isPlaceholder = typeof ColosseumConfig !== 'undefined' && ColosseumConfig.placeholderMode?.supabase;
if (isPlaceholder) {
  document.getElementById('placeholder-banner').style.display = 'block';
}

// --- Populate DOB selects ---
const daySelect = document.getElementById('dob-day');
for (let i = 1; i <= 31; i++) {
  const opt = document.createElement('option');
  opt.value = i;
  opt.textContent = i;
  daySelect.appendChild(opt);
}
const yearSelect = document.getElementById('dob-year');
const currentYear = new Date().getFullYear();
for (let y = currentYear - 10; y >= currentYear - 100; y--) {
  const opt = document.createElement('option');
  opt.value = y;
  opt.textContent = y;
  yearSelect.appendChild(opt);
}

// --- Tab switching ---
document.querySelectorAll('.login-tab').forEach(tab => {
  tab.addEventListener('click', () => {
    document.querySelectorAll('.login-tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.login-form').forEach(f => f.classList.remove('active'));
    tab.classList.add('active');
    document.getElementById('form-' + tab.dataset.tab).classList.add('active');
  });
});

// --- Show message ---
function showMsg(id, text, type) {
  const el = document.getElementById(id);
  el.className = 'form-msg ' + type;
  el.textContent = text;
}
function clearMsg(id) {
  const el = document.getElementById(id);
  el.className = 'form-msg';
  el.textContent = '';
}

// --- Age check (13+) ---
function getAge(month, day, year) {
  const today = new Date();
  const birth = new Date(year, month - 1, day);
  let age = today.getFullYear() - birth.getFullYear();
  const m = today.getMonth() - birth.getMonth();
  if (m < 0 || (m === 0 && today.getDate() < birth.getDate())) age--;
  return age;
}

// --- Rate Limiting (Item 14.4.1.16) ---
const loginAttempts = { count: 0, lastAttempt: 0, lockedUntil: 0 };
const MAX_ATTEMPTS = 5;
const LOCKOUT_MS = 60000; // 60 seconds

function checkRateLimit() {
  const now = Date.now();
  if (now < loginAttempts.lockedUntil) {
    const secsLeft = Math.ceil((loginAttempts.lockedUntil - now) / 1000);
    return { allowed: false, message: `Too many attempts. Try again in ${secsLeft}s.` };
  }
  // Reset counter if last attempt was >5 min ago
  if (now - loginAttempts.lastAttempt > 300000) {
    loginAttempts.count = 0;
  }
  return { allowed: true };
}

function recordFailedAttempt() {
  loginAttempts.count++;
  loginAttempts.lastAttempt = Date.now();
  if (loginAttempts.count >= MAX_ATTEMPTS) {
    loginAttempts.lockedUntil = Date.now() + LOCKOUT_MS;
    loginAttempts.count = 0;
  }
}

// --- LOGIN ---
document.getElementById('form-login').addEventListener('submit', async (e) => {
  e.preventDefault();
  clearMsg('login-msg');

  const rateCheck = checkRateLimit();
  if (!rateCheck.allowed) {
    showMsg('login-msg', rateCheck.message, 'error');
    return;
  }

  const email = document.getElementById('login-email').value.trim();
  const password = document.getElementById('login-password').value;

  if (!email || !password) {
    showMsg('login-msg', 'Please fill in all fields.', 'error');
    return;
  }

  if (isPlaceholder) {
    // Demo mode — skip to app
    showMsg('login-msg', 'Demo mode — entering the arena...', 'success');
    setTimeout(() => { window.location.href = 'index.html'; }, 800);
    return;
  }

  const btn = document.getElementById('login-btn');
  btn.disabled = true;
  btn.textContent = 'ENTERING...';

  try {
    const result = await ColosseumAuth.logIn({ email, password });
    if (!result.success) {
      recordFailedAttempt();
      showMsg('login-msg', result.error || 'Login failed.', 'error');
      btn.disabled = false;
      btn.textContent = 'ENTER THE ARENA';
    } else {
      showMsg('login-msg', 'Welcome back, gladiator.', 'success');
      setTimeout(() => { window.location.href = 'index.html'; }, 600);
    }
  } catch (err) {
    showMsg('login-msg', 'Something went wrong. Try again.', 'error');
    btn.disabled = false;
    btn.textContent = 'ENTER THE ARENA';
  }
});

// --- SIGNUP ---
document.getElementById('form-signup').addEventListener('submit', async (e) => {
  e.preventDefault();
  clearMsg('signup-msg');

  const username = document.getElementById('signup-username').value.trim();
  const email = document.getElementById('signup-email').value.trim();
  const password = document.getElementById('signup-password').value;
  const month = document.getElementById('dob-month').value;
  const day = document.getElementById('dob-day').value;
  const year = document.getElementById('dob-year').value;
  const tos = document.getElementById('tos-check').checked;

  if (!username || !email || !password || !month || !day || !year) {
    showMsg('signup-msg', 'Please fill in all fields.', 'error');
    return;
  }

  // Username validation (Item 14.4.2.3)
  if (username.length < 3 || username.length > 20) {
    showMsg('signup-msg', 'Username must be 3-20 characters.', 'error');
    return;
  }
  if (!/^[a-zA-Z0-9_]+$/.test(username)) {
    showMsg('signup-msg', 'Username: letters, numbers, and underscores only.', 'error');
    return;
  }

  if (password.length < 8) {
    showMsg('signup-msg', 'Password must be at least 8 characters.', 'error');
    return;
  }

  if (!tos) {
    showMsg('signup-msg', 'You must agree to the Terms of Service.', 'error');
    return;
  }

  const age = getAge(parseInt(month), parseInt(day), parseInt(year));
  if (age < 13) {
    showMsg('signup-msg', 'You must be at least 13 years old to use The Colosseum.', 'error');
    return;
  }

  if (isPlaceholder) {
    showMsg('signup-msg', 'Demo mode — account created! Entering arena...', 'success');
    setTimeout(() => { window.location.href = 'index.html'; }, 800);
    return;
  }

  const btn = document.getElementById('signup-btn');
  btn.disabled = true;
  btn.textContent = 'CREATING...';

  try {
    const dob = `${year}-${String(month).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
    const result = await ColosseumAuth.signUp({
      email,
      password,
      username,
      displayName: username,
      dob,
    });

    if (!result.success) {
      showMsg('signup-msg', result.error || 'Signup failed.', 'error');
      btn.disabled = false;
      btn.textContent = 'CREATE ACCOUNT';
    } else {
      showMsg('signup-msg', 'Account created! Check your email to confirm.', 'success');
      setTimeout(() => { window.location.href = 'index.html'; }, 1200);
    }
  } catch (err) {
    showMsg('signup-msg', 'Something went wrong. Try again.', 'error');
    btn.disabled = false;
    btn.textContent = 'CREATE ACCOUNT';
  }
});

// --- OAuth ---
function handleOAuth(provider) {
  if (isPlaceholder) {
    const formActive = document.querySelector('.login-form.active');
    const msgId = formActive.id === 'form-login' ? 'login-msg' : 'signup-msg';
    showMsg(msgId, `Demo mode — ${provider} OAuth not available without Supabase.`, 'error');
    return;
  }
  if (typeof ColosseumAuth !== 'undefined' && ColosseumAuth.oauthLogin) {
    ColosseumAuth.oauthLogin(provider);
  }
}

document.getElementById('oauth-google').addEventListener('click', () => handleOAuth('google'));
document.getElementById('oauth-apple-login').addEventListener('click', () => handleOAuth('apple'));
document.getElementById('oauth-google-signup').addEventListener('click', () => handleOAuth('google'));
document.getElementById('oauth-apple-signup').addEventListener('click', () => handleOAuth('apple'));

// --- Password Reset Modal ---
document.getElementById('forgot-link').addEventListener('click', (e) => {
  e.preventDefault();
  document.getElementById('reset-modal').classList.add('open');
  document.getElementById('reset-email').value = document.getElementById('login-email').value;
});
document.getElementById('reset-close').addEventListener('click', () => {
  document.getElementById('reset-modal').classList.remove('open');
});
document.getElementById('reset-modal').addEventListener('click', (e) => {
  if (e.target === e.currentTarget) e.currentTarget.classList.remove('open');
});

document.getElementById('reset-btn').addEventListener('click', async () => {
  const email = document.getElementById('reset-email').value.trim();
  if (!email) {
    showMsg('reset-msg', 'Enter your email.', 'error');
    return;
  }
  if (isPlaceholder) {
    showMsg('reset-msg', 'Demo mode — no email sent.', 'error');
    return;
  }
  try {
    await ColosseumAuth.resetPassword(email);
    showMsg('reset-msg', 'Reset link sent! Check your inbox.', 'success');
  } catch {
    showMsg('reset-msg', 'Could not send reset link.', 'error');
  }
});

// --- Set New Password (after clicking reset link in email) ---
document.getElementById('newpw-btn').addEventListener('click', async () => {
  const pw = document.getElementById('newpw-password').value;
  const confirm = document.getElementById('newpw-confirm').value;

  if (!pw || pw.length < 8) {
    showMsg('newpw-msg', 'Password must be at least 8 characters.', 'error');
    return;
  }
  if (pw !== confirm) {
    showMsg('newpw-msg', 'Passwords do not match.', 'error');
    return;
  }

  const btn = document.getElementById('newpw-btn');
  btn.disabled = true;
  btn.textContent = 'UPDATING...';

  try {
    const result = await ColosseumAuth.updatePassword(pw);
    if (!result.success) {
      showMsg('newpw-msg', result.error || 'Could not update password.', 'error');
      btn.disabled = false;
      btn.textContent = 'UPDATE PASSWORD';
    } else {
      showMsg('newpw-msg', '✅ Password updated! Entering the arena...', 'success');
      setTimeout(() => { window.location.href = 'index.html'; }, 1200);
    }
  } catch (err) {
    showMsg('newpw-msg', 'Something went wrong. Try again.', 'error');
    btn.disabled = false;
    btn.textContent = 'UPDATE PASSWORD';
  }
});

// --- If already logged in, go to app ---
window.addEventListener('DOMContentLoaded', () => {
  // Handle email confirmation / password reset redirect (Supabase appends #access_token=...)
  const hash = window.location.hash;
  if (hash && hash.includes('access_token')) {
    const params = new URLSearchParams(hash.substring(1));
    const type = params.get('type');
    
    if (type === 'signup' || type === 'email') {
      showMsg('login-msg', '✅ Email confirmed! Entering the arena...', 'success');
      setTimeout(() => { window.location.href = 'index.html'; }, 1200);
      return;
    }
    if (type === 'recovery') {
      // Show the "Set New Password" modal
      document.getElementById('newpw-modal').classList.add('open');
      return;
    }
  }

  if (typeof ColosseumAuth !== 'undefined' && ColosseumAuth.currentUser && !isPlaceholder) {
    window.location.href = 'index.html';
  }
});
</script>
</body>
</html>
