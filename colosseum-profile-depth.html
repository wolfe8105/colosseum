<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#0a1628">
<title>Complete Your Profile ‚Äî The Colosseum</title>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="colosseum-config.js"></script>
<script src="colosseum-auth.js"></script>

<style>
  @import url('https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Source+Sans+3:wght@400;600;700&display=swap');

  :root {
    --navy: #0a1628;
    --navy-light: #132240;
    --navy-mid: #1a2d4a;
    --red: #cc2936;
    --red-hover: #e63946;
    --gold: #d4a843;
    --gold-dim: #b8922e;
    --white: #f0f0f0;
    --white-dim: #a0a8b8;
    --error: #e74c3c;
    --success: #2ecc71;
    --font-display: 'Bebas Neue', sans-serif;
    --font-body: 'Source Sans 3', sans-serif;
    --safe-top: env(safe-area-inset-top, 0px);
    --safe-bottom: env(safe-area-inset-bottom, 0px);
  }

  *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: var(--font-body);
    background: var(--navy);
    color: var(--white);
    min-height: 100dvh;
    padding: calc(16px + var(--safe-top)) 16px calc(80px + var(--safe-bottom));
    -webkit-font-smoothing: antialiased;
  }

  /* === BACK BAR === */
  .back-bar {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 16px;
  }
  .back-btn {
    min-width: 44px; min-height: 44px;
    display: flex; align-items: center; justify-content: center;
    background: var(--navy-light);
    border: 1px solid rgba(255,255,255,0.08);
    border-radius: 10px;
    color: var(--white);
    font-size: 20px;
    text-decoration: none;
    -webkit-tap-highlight-color: transparent;
  }
  .page-title {
    font-family: var(--font-display);
    font-size: 22px;
    letter-spacing: 3px;
  }

  /* === DISCOUNT BANNER === */
  .discount-banner {
    background: linear-gradient(135deg, var(--navy-light), var(--navy-mid));
    border: 1px solid var(--gold-dim);
    border-radius: 12px;
    padding: 16px;
    margin-bottom: 20px;
    text-align: center;
  }
  .discount-current {
    font-family: var(--font-display);
    font-size: 32px;
    letter-spacing: 2px;
    color: var(--gold);
    line-height: 1;
  }
  .discount-original {
    font-size: 14px;
    color: var(--white-dim);
    text-decoration: line-through;
    margin-top: 2px;
  }
  .discount-label {
    font-size: 13px;
    color: var(--white-dim);
    margin-top: 6px;
  }
  .discount-progress {
    width: 100%;
    height: 8px;
    background: var(--navy);
    border-radius: 4px;
    margin-top: 10px;
    overflow: hidden;
  }
  .discount-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--gold-dim), var(--gold));
    border-radius: 4px;
    transition: width 0.6s ease;
  }
  .discount-pct {
    font-size: 12px;
    color: var(--white-dim);
    margin-top: 4px;
  }

  /* === SECTION GRID === */
  .section-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 10px;
    margin-bottom: 20px;
  }
  @media (min-width: 480px) { .section-grid { grid-template-columns: repeat(3, 1fr); } }

  .section-tile {
    background: var(--navy-light);
    border: 1px solid rgba(255,255,255,0.06);
    border-radius: 12px;
    padding: 14px 10px;
    text-align: center;
    cursor: pointer;
    -webkit-tap-highlight-color: transparent;
    position: relative;
    transition: border-color 0.2s;
  }
  .section-tile:active { background: var(--navy-mid); }
  .section-tile.complete { border-color: var(--success); }
  .section-tile.active-section { border-color: var(--gold); }

  .section-icon { font-size: 24px; margin-bottom: 4px; }
  .section-name {
    font-family: var(--font-display);
    font-size: 12px;
    letter-spacing: 1px;
    color: var(--white-dim);
  }

  /* Mini progress ring */
  .section-ring {
    position: absolute;
    top: 6px; right: 6px;
    width: 22px; height: 22px;
  }
  .section-ring svg { width: 22px; height: 22px; transform: rotate(-90deg); }
  .section-ring circle {
    fill: none;
    stroke-width: 3;
    cx: 11; cy: 11; r: 9;
  }
  .ring-bg { stroke: var(--navy-mid); }
  .ring-fill { stroke: var(--gold); stroke-linecap: round; transition: stroke-dashoffset 0.6s; }

  .section-check {
    position: absolute;
    top: 6px; right: 6px;
    font-size: 16px;
  }

  /* === QUESTION PANEL === */
  .question-panel {
    display: none;
    margin-bottom: 20px;
  }
  .question-panel.open { display: block; }

  .panel-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 12px;
  }
  .panel-title {
    font-family: var(--font-display);
    font-size: 18px;
    letter-spacing: 2px;
  }
  .panel-reward {
    font-size: 12px;
    color: var(--gold);
    background: rgba(212,168,67,0.1);
    padding: 4px 10px;
    border-radius: 6px;
  }

  .question-card {
    background: var(--navy-light);
    border: 1px solid rgba(255,255,255,0.06);
    border-radius: 10px;
    padding: 14px 16px;
    margin-bottom: 10px;
  }
  .question-label {
    font-size: 14px;
    font-weight: 600;
    margin-bottom: 8px;
  }

  /* Chips */
  .chip-group { display: flex; flex-wrap: wrap; gap: 6px; }
  .chip {
    padding: 6px 14px;
    border-radius: 20px;
    background: var(--navy);
    border: 1px solid rgba(255,255,255,0.1);
    color: var(--white-dim);
    font-size: 13px;
    cursor: pointer;
    -webkit-tap-highlight-color: transparent;
    transition: all 0.15s;
  }
  .chip.selected { background: rgba(212,168,67,0.2); border-color: var(--gold-dim); color: var(--gold); }

  /* Input */
  .q-input {
    width: 100%;
    min-height: 44px;
    padding: 10px 14px;
    background: var(--navy);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 8px;
    color: var(--white);
    font-family: var(--font-body);
    font-size: 16px;
    outline: none;
  }
  .q-input:focus { border-color: var(--gold-dim); }

  /* Slider */
  .slider-row { display: flex; align-items: center; gap: 10px; }
  .q-slider {
    flex: 1;
    -webkit-appearance: none;
    appearance: none;
    height: 6px;
    background: var(--navy-mid);
    border-radius: 3px;
    outline: none;
  }
  .q-slider::-webkit-slider-thumb {
    -webkit-appearance: none;
    width: 22px; height: 22px;
    background: var(--gold);
    border-radius: 50%;
    cursor: pointer;
  }
  .slider-val {
    font-family: var(--font-display);
    font-size: 16px;
    color: var(--gold);
    min-width: 30px;
    text-align: center;
  }

  /* Select */
  .q-select {
    width: 100%;
    min-height: 44px;
    padding: 10px 14px;
    background: var(--navy);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: 8px;
    color: var(--white);
    font-family: var(--font-body);
    font-size: 15px;
    outline: none;
    -webkit-appearance: none;
  }

  /* Save section btn */
  .save-section-btn {
    width: 100%;
    min-height: 44px;
    padding: 10px;
    background: var(--gold-dim);
    color: var(--navy);
    border: none;
    border-radius: 8px;
    font-family: var(--font-display);
    font-size: 16px;
    letter-spacing: 2px;
    cursor: pointer;
    margin-top: 10px;
  }
  .save-section-btn:active { background: var(--gold); }

  /* === REWARD TOAST === */
  .reward-toast {
    position: fixed;
    top: 50%; left: 50%;
    transform: translate(-50%, -50%) scale(0.8);
    background: var(--navy-light);
    border: 2px solid var(--gold);
    border-radius: 16px;
    padding: 24px 32px;
    text-align: center;
    z-index: 9999;
    opacity: 0;
    pointer-events: none;
    transition: all 0.3s ease;
  }
  .reward-toast.show {
    opacity: 1;
    transform: translate(-50%, -50%) scale(1);
  }
  .reward-toast .reward-icon { font-size: 40px; margin-bottom: 8px; }
  .reward-toast .reward-text {
    font-family: var(--font-display);
    font-size: 18px;
    letter-spacing: 2px;
    color: var(--gold);
  }
  .reward-toast .reward-desc {
    font-size: 13px;
    color: var(--white-dim);
    margin-top: 4px;
  }
</style>
</head>
<body>

<div class="back-bar">
  <a href="index.html" class="back-btn">‚Üê</a>
  <div class="page-title">COMPLETE PROFILE</div>
</div>

<!-- Discount waterfall banner -->
<div class="discount-banner">
  <div class="discount-original">$14.99/mo</div>
  <div class="discount-current" id="discount-price">$14.99<span style="font-size:14px;color:var(--white-dim);">/mo</span></div>
  <div class="discount-label">Complete sections to unlock your discount</div>
  <div class="discount-progress">
    <div class="discount-fill" id="discount-fill" style="width:0%"></div>
  </div>
  <div class="discount-pct" id="discount-pct">0 of 12 sections complete</div>
</div>

<!-- Section tiles grid -->
<div class="section-grid" id="section-grid"></div>

<!-- Question panel (opens when section tapped) -->
<div class="question-panel" id="question-panel"></div>

<!-- Reward toast -->
<div class="reward-toast" id="reward-toast">
  <div class="reward-icon" id="reward-icon">üèÜ</div>
  <div class="reward-text" id="reward-text">SECTION COMPLETE</div>
  <div class="reward-desc" id="reward-desc">You unlocked a badge!</div>
</div>

<script>
// ============================================================
// PROFILE DEPTH ENGINE
// Item 3.6: 12 sections, 157 Qs, mixed rewards, $14.99‚Üí$0.49
// Item 3.7: Not always money ‚Äî discounts, badges, icons, cosmetics
// Item 7.7: Reciprocal gating
// ============================================================

const SECTIONS = [
  {
    id: 'basics', icon: 'üë§', name: 'THE BASICS',
    reward: { type: 'discount', text: '$1 off subscription' },
    questions: [
      { id: 'b1', label: 'What should people call you?', type: 'input', placeholder: 'Display name' },
      { id: 'b2', label: 'Where are you from?', type: 'input', placeholder: 'City, State' },
      { id: 'b3', label: 'Gender', type: 'chips', options: ['Male', 'Female', 'Non-binary', 'Prefer not to say'] },
      { id: 'b4', label: 'Age range', type: 'chips', options: ['16-18', '19-24', '25-34', '35-44', '45-54', '55+'] },
    ]
  },
  {
    id: 'politics', icon: 'üèõÔ∏è', name: 'POLITICS',
    reward: { type: 'badge', text: 'Unlock "Policy Wonk" badge' },
    questions: [
      { id: 'p1', label: 'Where do you lean politically?', type: 'slider', min: 1, max: 10, labels: ['Far Left', 'Far Right'] },
      { id: 'p2', label: 'Top 3 political issues you care about', type: 'chips', multi: true, max: 3, options: ['Economy', 'Immigration', 'Healthcare', 'Climate', 'Education', 'Foreign Policy', 'Gun Rights', 'Social Justice', 'Tax Reform', 'Housing'] },
      { id: 'p3', label: 'How often do you discuss politics?', type: 'chips', options: ['Daily', 'Weekly', 'Monthly', 'Rarely'] },
    ]
  },
  {
    id: 'sports', icon: 'üèüÔ∏è', name: 'SPORTS',
    reward: { type: 'cosmetic', text: 'Unlock "Arena Glow" profile effect' },
    questions: [
      { id: 's1', label: 'Favorite sports (pick up to 3)', type: 'chips', multi: true, max: 3, options: ['NFL', 'NBA', 'MLB', 'NHL', 'Soccer', 'MMA/UFC', 'Boxing', 'College FB', 'College BB', 'Tennis', 'Golf', 'F1'] },
      { id: 's2', label: 'Hottest take you believe about sports?', type: 'input', placeholder: 'e.g. MJ > LeBron, no debate' },
      { id: 's3', label: 'How deep is your sports knowledge?', type: 'slider', min: 1, max: 10, labels: ['Casual', 'Stat Nerd'] },
    ]
  },
  {
    id: 'entertainment', icon: 'üé¨', name: 'ENTERTAINMENT',
    reward: { type: 'badge', text: 'Unlock "Critic" badge' },
    questions: [
      { id: 'e1', label: 'What do you watch/consume most?', type: 'chips', multi: true, max: 3, options: ['Movies', 'TV Series', 'YouTube', 'Podcasts', 'Anime', 'Reality TV', 'Documentaries', 'Live Sports'] },
      { id: 'e2', label: 'Most overrated movie or show?', type: 'input', placeholder: 'Name it...' },
      { id: 'e3', label: 'Music genre that defines you', type: 'chips', options: ['Hip Hop', 'Rock', 'Pop', 'Country', 'R&B', 'EDM', 'Jazz', 'Latin', 'Classical', 'Metal'] },
    ]
  },
  {
    id: 'debate_style', icon: '‚öîÔ∏è', name: 'DEBATE STYLE',
    reward: { type: 'discount', text: '$1.50 off subscription' },
    questions: [
      { id: 'd1', label: 'How do you argue?', type: 'chips', options: ['Facts & data', 'Emotion & passion', 'Humor & wit', 'Experience & stories'] },
      { id: 'd2', label: 'When you lose an argument, you...', type: 'chips', options: ['Accept it gracefully', 'Double down', 'Change the subject', 'Research more'] },
      { id: 'd3', label: 'Debate experience level', type: 'slider', min: 1, max: 10, labels: ['First timer', 'Veteran'] },
    ]
  },
  {
    id: 'opinions', icon: 'üî•', name: 'HOT OPINIONS',
    reward: { type: 'cosmetic', text: 'Unlock "Flame Border" profile frame' },
    questions: [
      { id: 'o1', label: 'AI will replace most jobs by 2035', type: 'slider', min: 1, max: 10, labels: ['Disagree', 'Agree'] },
      { id: 'o2', label: 'Social media does more harm than good', type: 'slider', min: 1, max: 10, labels: ['Disagree', 'Agree'] },
      { id: 'o3', label: 'College is still worth the cost', type: 'slider', min: 1, max: 10, labels: ['Disagree', 'Agree'] },
      { id: 'o4', label: 'What hill will you die on?', type: 'input', placeholder: 'Your #1 unpopular opinion' },
    ]
  },
  {
    id: 'values', icon: '‚öñÔ∏è', name: 'VALUES',
    reward: { type: 'discount', text: '$1.50 off subscription' },
    questions: [
      { id: 'v1', label: 'Freedom vs Security ‚Äî where do you land?', type: 'slider', min: 1, max: 10, labels: ['Freedom', 'Security'] },
      { id: 'v2', label: 'Tradition vs Progress', type: 'slider', min: 1, max: 10, labels: ['Tradition', 'Progress'] },
      { id: 'v3', label: 'Individual vs Collective', type: 'slider', min: 1, max: 10, labels: ['Individual', 'Collective'] },
    ]
  },
  {
    id: 'media', icon: 'üì±', name: 'MEDIA DIET',
    reward: { type: 'badge', text: 'Unlock "Informed" badge' },
    questions: [
      { id: 'm1', label: 'Where do you get your news?', type: 'chips', multi: true, max: 3, options: ['TV News', 'Twitter/X', 'Reddit', 'Podcasts', 'Newspapers', 'YouTube', 'TikTok', 'Word of mouth'] },
      { id: 'm2', label: 'Daily screen time (hours)', type: 'slider', min: 1, max: 12, labels: ['1hr', '12hr'] },
      { id: 'm3', label: 'Do you trust mainstream media?', type: 'slider', min: 1, max: 10, labels: ['Not at all', 'Completely'] },
    ]
  },
  {
    id: 'lifestyle', icon: 'üè†', name: 'LIFESTYLE',
    reward: { type: 'discount', text: '$2 off subscription' },
    questions: [
      { id: 'l1', label: 'Education level', type: 'select', options: ['High school', 'Some college', 'Associate', 'Bachelor', 'Master', 'Doctorate', 'Trade school', 'Self-taught'] },
      { id: 'l2', label: 'What field do you work in?', type: 'input', placeholder: 'e.g. Tech, Healthcare, Student...' },
      { id: 'l3', label: 'Urban, suburban, or rural?', type: 'chips', options: ['Urban', 'Suburban', 'Rural'] },
    ]
  },
  {
    id: 'competition', icon: 'üèÜ', name: 'COMPETITIVE',
    reward: { type: 'cosmetic', text: 'Unlock "Gold Crown" icon' },
    questions: [
      { id: 'c1', label: 'How competitive are you?', type: 'slider', min: 1, max: 10, labels: ['Chill', 'Win at all costs'] },
      { id: 'c2', label: 'Winning matters more than...', type: 'chips', options: ['Being liked', 'Being right', 'Having fun', 'Nothing ‚Äî winning IS the point'] },
      { id: 'c3', label: 'Best trash talk style', type: 'chips', options: ['Silent dominance', 'Witty burns', 'Stats bombardment', 'Psychological warfare'] },
    ]
  },
  {
    id: 'social', icon: 'ü§ù', name: 'SOCIAL',
    reward: { type: 'feature', text: 'Unlock custom bio' },
    questions: [
      { id: 'x1', label: 'How did you hear about The Colosseum?', type: 'chips', options: ['Friend', 'Social media', 'Search', 'Ad', 'Podcast', 'Other'] },
      { id: 'x2', label: 'Would you refer friends?', type: 'chips', options: ['Already did', 'Definitely', 'Maybe', 'Probably not'] },
      { id: 'x3', label: 'What would make this app essential?', type: 'input', placeholder: 'One feature that would hook you...' },
    ]
  },
  {
    id: 'identity', icon: 'üé≠', name: 'IDENTITY',
    reward: { type: 'discount', text: '$3 off ‚Äî final discount! Down to $0.49' },
    questions: [
      { id: 'i1', label: 'Describe yourself in 3 words', type: 'input', placeholder: 'e.g. stubborn, funny, relentless' },
      { id: 'i2', label: 'Your debate walkout song would be...', type: 'input', placeholder: 'Name the track' },
      { id: 'i3', label: 'If you could debate anyone alive, who?', type: 'input', placeholder: 'Name them' },
      { id: 'i4', label: 'Why did you really download this app?', type: 'chips', options: ['Prove I\'m right', 'Learn other views', 'Entertainment', 'Sharpen my skills', 'Talk sh*t'] },
    ]
  }
];

// --- Discount waterfall (Item 3.6) ---
// $14.99 base ‚Üí each section reduces by a portion ‚Üí minimum $0.49
const BASE_PRICE = 14.99;
const MIN_PRICE = 0.49;
const STEP = (BASE_PRICE - MIN_PRICE) / SECTIONS.length;

// --- State ---
let answers = JSON.parse(localStorage.getItem('colosseum_profile_depth') || '{}');
let completedSections = new Set(JSON.parse(localStorage.getItem('colosseum_depth_complete') || '[]'));
let activeSection = null;

// --- Discount calc ---
function calcPrice() {
  const count = completedSections.size;
  return Math.max(MIN_PRICE, BASE_PRICE - (count * STEP)).toFixed(2);
}

function updateDiscount() {
  const count = completedSections.size;
  document.getElementById('discount-price').innerHTML = `$${calcPrice()}<span style="font-size:14px;color:var(--white-dim);">/mo</span>`;
  document.getElementById('discount-fill').style.width = ((count / SECTIONS.length) * 100) + '%';
  document.getElementById('discount-pct').textContent = `${count} of ${SECTIONS.length} sections complete`;
}

// --- Ring SVG ---
function ringSVG(pct) {
  const circumference = 2 * Math.PI * 9;
  const offset = circumference - (pct / 100) * circumference;
  return `<svg><circle class="ring-bg" cx="11" cy="11" r="9"/><circle class="ring-fill" cx="11" cy="11" r="9" stroke-dasharray="${circumference}" stroke-dashoffset="${offset}"/></svg>`;
}

// --- Section completion % ---
function sectionPct(section) {
  const total = section.questions.length;
  let answered = 0;
  section.questions.forEach(q => {
    const val = answers[q.id];
    if (val !== undefined && val !== '' && val !== null) {
      if (Array.isArray(val) && val.length > 0) answered++;
      else if (!Array.isArray(val)) answered++;
    }
  });
  return Math.round((answered / total) * 100);
}

// --- Render section grid ---
function renderGrid() {
  const grid = document.getElementById('section-grid');
  grid.innerHTML = SECTIONS.map(s => {
    const done = completedSections.has(s.id);
    const pct = sectionPct(s);
    const isActive = activeSection === s.id;
    return `
      <div class="section-tile ${done ? 'complete' : ''} ${isActive ? 'active-section' : ''}" data-section="${s.id}">
        ${done ? '<span class="section-check">‚úÖ</span>' : `<div class="section-ring">${ringSVG(pct)}</div>`}
        <div class="section-icon">${s.icon}</div>
        <div class="section-name">${s.name}</div>
      </div>
    `;
  }).join('');

  grid.querySelectorAll('.section-tile').forEach(tile => {
    tile.addEventListener('click', () => openSection(tile.dataset.section));
  });
}

// --- Open section ---
function openSection(sectionId) {
  activeSection = sectionId;
  const section = SECTIONS.find(s => s.id === sectionId);
  if (!section) return;

  const panel = document.getElementById('question-panel');
  panel.classList.add('open');

  panel.innerHTML = `
    <div class="panel-header">
      <div class="panel-title">${section.icon} ${section.name}</div>
      <div class="panel-reward">üéÅ ${section.reward.text}</div>
    </div>
    ${section.questions.map(q => renderQuestion(q)).join('')}
    <button class="save-section-btn" id="save-section-btn">SAVE & UNLOCK REWARD</button>
  `;

  // Wire up interactions
  wireQuestions(section);

  document.getElementById('save-section-btn').addEventListener('click', () => saveSection(section));

  // Scroll to panel
  panel.scrollIntoView({ behavior: 'smooth', block: 'start' });

  renderGrid();
}

// --- Render individual question ---
function renderQuestion(q) {
  const val = answers[q.id];

  if (q.type === 'input') {
    return `
      <div class="question-card">
        <div class="question-label">${q.label}</div>
        <input class="q-input" data-qid="${q.id}" type="text" placeholder="${q.placeholder || ''}" value="${val || ''}">
      </div>`;
  }

  if (q.type === 'chips') {
    const selected = q.multi ? (Array.isArray(val) ? val : []) : [val];
    return `
      <div class="question-card">
        <div class="question-label">${q.label}${q.max ? ` (max ${q.max})` : ''}</div>
        <div class="chip-group" data-qid="${q.id}" data-multi="${!!q.multi}" data-max="${q.max || 99}">
          ${q.options.map(o => `<div class="chip ${selected.includes(o) ? 'selected' : ''}" data-val="${o}">${o}</div>`).join('')}
        </div>
      </div>`;
  }

  if (q.type === 'slider') {
    const current = val !== undefined ? val : Math.round((q.min + q.max) / 2);
    return `
      <div class="question-card">
        <div class="question-label">${q.label}</div>
        <div style="display:flex;justify-content:space-between;font-size:11px;color:var(--white-dim);margin-bottom:4px;">
          <span>${q.labels[0]}</span><span>${q.labels[1]}</span>
        </div>
        <div class="slider-row">
          <input class="q-slider" data-qid="${q.id}" type="range" min="${q.min}" max="${q.max}" value="${current}">
          <span class="slider-val" id="slider-val-${q.id}">${current}</span>
        </div>
      </div>`;
  }

  if (q.type === 'select') {
    return `
      <div class="question-card">
        <div class="question-label">${q.label}</div>
        <select class="q-select" data-qid="${q.id}">
          <option value="" disabled ${!val ? 'selected' : ''}>Choose one...</option>
          ${q.options.map(o => `<option value="${o}" ${val === o ? 'selected' : ''}>${o}</option>`).join('')}
        </select>
      </div>`;
  }

  return '';
}

// --- Wire question interactivity ---
function wireQuestions(section) {
  // Inputs
  document.querySelectorAll('.q-input').forEach(el => {
    el.addEventListener('input', () => { answers[el.dataset.qid] = el.value; });
  });

  // Chips
  document.querySelectorAll('.chip-group').forEach(group => {
    const isMulti = group.dataset.multi === 'true';
    const max = parseInt(group.dataset.max) || 99;
    group.querySelectorAll('.chip').forEach(chip => {
      chip.addEventListener('click', () => {
        const qid = group.dataset.qid;
        const val = chip.dataset.val;
        if (isMulti) {
          let arr = Array.isArray(answers[qid]) ? [...answers[qid]] : [];
          if (arr.includes(val)) {
            arr = arr.filter(v => v !== val);
            chip.classList.remove('selected');
          } else if (arr.length < max) {
            arr.push(val);
            chip.classList.add('selected');
          }
          answers[qid] = arr;
        } else {
          group.querySelectorAll('.chip').forEach(c => c.classList.remove('selected'));
          chip.classList.add('selected');
          answers[qid] = val;
        }
      });
    });
  });

  // Sliders
  document.querySelectorAll('.q-slider').forEach(el => {
    el.addEventListener('input', () => {
      answers[el.dataset.qid] = parseInt(el.value);
      const label = document.getElementById('slider-val-' + el.dataset.qid);
      if (label) label.textContent = el.value;
    });
  });

  // Selects
  document.querySelectorAll('.q-select').forEach(el => {
    el.addEventListener('change', () => { answers[el.dataset.qid] = el.value; });
  });
}

// --- Save section ---
function saveSection(section) {
  // Check all questions answered
  let allAnswered = true;
  section.questions.forEach(q => {
    const val = answers[q.id];
    if (val === undefined || val === '' || val === null || (Array.isArray(val) && val.length === 0)) {
      allAnswered = false;
    }
  });

  if (!allAnswered) {
    // Highlight unanswered ‚Äî just save what we have
  }

  // Save to localStorage
  localStorage.setItem('colosseum_profile_depth', JSON.stringify(answers));

  if (allAnswered) {
    completedSections.add(section.id);
    localStorage.setItem('colosseum_depth_complete', JSON.stringify([...completedSections]));

    // Show reward toast
    showReward(section.reward);
  }

  // Save to Supabase if available
  if (typeof ColosseumAuth !== 'undefined' && ColosseumAuth.currentUser && !ColosseumConfig?.placeholderMode?.supabase) {
    // Would call Supabase upsert here
  }

  updateDiscount();
  renderGrid();

  // Close panel after short delay
  if (allAnswered) {
    setTimeout(() => {
      document.getElementById('question-panel').classList.remove('open');
      activeSection = null;
      renderGrid();
    }, 2000);
  }
}

// --- Reward toast ---
function showReward(reward) {
  const icons = { discount: 'üí∞', badge: 'üõ°Ô∏è', cosmetic: '‚ú®', feature: 'üîì' };
  document.getElementById('reward-icon').textContent = icons[reward.type] || 'üèÜ';
  document.getElementById('reward-text').textContent = 'SECTION COMPLETE';
  document.getElementById('reward-desc').textContent = reward.text;

  const toast = document.getElementById('reward-toast');
  toast.classList.add('show');
  setTimeout(() => toast.classList.remove('show'), 2500);
}

// --- Init ---
window.addEventListener('DOMContentLoaded', () => {
  renderGrid();
  updateDiscount();
});
</script>
</body>
</html>
